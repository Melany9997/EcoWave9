<h1 class="ecowave-header">EcoWave</h1>
<h2><%= @project.name %></h2>


 <div class="material-photo-container">
    <%= link_to edit_project_path(@project), class: "material-photo-link" do %>
    <% if @project.photo.attached? %>
      <%= cl_image_tag @project.photo.key, class: "material-photo", crop: :fill, alt: "Material Photo" %>
    <% else %>
      <p>No image available</p>
    <% end %>
      <div class="quantity-toggle">
        +/-
      </div>
    <% end %>
  </div>




<div id="summary-section" data-controller="summary">
  <!-- Display summary text -->
  <p data-summary-target="text" data-action="click->summary#edit">
    <%= @project.summary.presence || "Click to add summary" %>
  </p>

  <!-- Form should be hidden by default -->
  <%= form_with model: @project, url: project_path(@project), method: :patch, local: true, data: { summary_target: "form", action: "submit->summary#save" }, style: "display: none;" do |f| %>
    <%= f.text_area :summary, rows: 5, class: "form-control", data: { summary_target: "textarea" } %>
    <br>
    <%= f.submit "Save", class: "btn btn-primary" %>
    <button type="button" data-action="summary#cancel" class="btn btn-secondary">Cancel</button>
  <% end %>
</div>


<!-- Environmental Score Heading -->
<h2 class="env-score-heading">PROJECT AVERAGE ENVIRONMENTAL SCORE</h2>

<% if @materials.any? %>
  <div class="materials-show-flex-wrapper">
    <!-- Average Water Usage -->
    <div class="materials-show-single-chart">
      <% water_avg = @project.average_water_usage %>
      <% water_ratio_avg = (water_avg / 2000.0) * 100 %>
      <% water_ratio_avg = 100 if water_ratio_avg > 100 %>

      <svg viewBox="0 0 36 36" class="materials-show-circular-chart materials-show-water-chart">
        <path class="materials-show-circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
        <path class="materials-show-circle" stroke-dasharray="<%= water_ratio_avg.round(1) %>, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
        <text x="18" y="20.35" class="materials-show-percentage">
          <%= water_avg.positive? ? "#{water_avg.round(1)} L/m²" : "Not Provided" %>
        </text>
      </svg>
      <p class="materials-show-chart-label">Water</p>
    </div>

    <!-- Average CO2 Emissions -->
    <div class="materials-show-single-chart">
      <% co2_avg = @project.average_co2_emissions %>
      <% co2_ratio_avg = (co2_avg / 2.0) * 100 %>
      <% co2_ratio_avg = 100 if co2_ratio_avg > 100 %>

      <svg viewBox="0 0 36 36" class="materials-show-circular-chart materials-show-co2-chart">
        <path class="materials-show-circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
        <path class="materials-show-circle" stroke-dasharray="<%= co2_ratio_avg.round(1) %>, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
        <text x="18" y="20.35" class="materials-show-percentage">
          <%= co2_avg.positive? ? "#{co2_avg.round(2)} kg/m²" : "Not Provided" %>
        </text>
      </svg>
      <p class="materials-show-chart-label">CO₂</p>
    </div>

    <!-- Average Electricity Usage -->
    <div class="materials-show-single-chart">
      <% electricity_avg = @project.average_electricity_usage %>
      <% electricity_ratio_avg = (electricity_avg / 1.0) * 100 %>
      <% electricity_ratio_avg = 100 if electricity_ratio_avg > 100 %>

      <svg viewBox="0 0 36 36" class="materials-show-circular-chart materials-show-electricity-chart">
        <path class="materials-show-circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
        <path class="materials-show-circle" stroke-dasharray="<%= electricity_ratio_avg.round(1) %>, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
        <text x="18" y="20.35" class="materials-show-percentage">
          <%= electricity_avg.positive? ? "#{electricity_avg.round(2)} kWh/m²" : "Not Provided" %>
        </text>
      </svg>
      <p class="materials-show-chart-label">Electricity</p>
    </div>
  </div>
<% else %>
  <p>No materials added to this project yet.</p>
<% end %>



  <!-- Material Details Card -->
  <div class="details-card">
    <h2 class="details-card-header">SELECTED FABRICS</h2>
      <div class="material-list">
        <% @project.materials.each do |material| %>
          <div class="material-item">
            <div class="material-info">
              <div class="material-header">
                <h3 class="material-name"><%= material.name %></h3>
                <div class="material-remove">
                  <%= button_to project_material_path(@project, material), method: :delete, data: { confirm: "Are you sure?" }, class: "btn-delete" do %>
                    <%= image_tag "bin.png", alt: "Delete", class: "bin-icon" %>
                  <% end %>
                </div>
              </div>
              <p>Quantity: <%= material.length %></p>
              <p>Environmental score: </p>
            </div>
          </div>
        <% end %>
      </div>


    <!-- NOTES at the Bottom -->
    <div id="notes-section" class="details-notes" data-controller="notes">
      NOTES:
      <p data-notes-target="text" data-action="click->notes#edit" >
       <%= @project.notes.presence || "Click here to add notes" %>
     </p>

    <!-- Editable Form for Notes -->
    <%= form_with model: @project, url: project_path(@project), method: :patch, local: true, data: { notes_target: "form", action: "submit->notes#save" }, style: "display: none;" do |f| %>
      <%= f.text_area :notes, rows: 5, class: "form-control", data: { notes_target: "textarea" } %>
      <br>
      <%= f.submit "Save", class: "btn btn-primary" %>
      <button type="button" data-action="notes#cancel" class="btn btn-secondary">Cancel</button>
    <% end %>
    </div>
  </div>
</div>

<div>
  <%= link_to "ADD FABRICS",  new_project_project_material_path(@project), class: "interface-white-button"  %>
  <%= link_to "DELETE PROJECT", project_path(@project), method: :delete, data: { confirm: "Are you sure?" }, class: "interface-black-button" %>
  <%= link_to "BACK", projects_path, class: "interface-white-button" %>
</div>
